---
title: "Visualising compositions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Visualising compositions}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, message=FALSE}
options(width = 100)
library(microViz)
library(phyloseq)
library(ggplot2)
library(patchwork) # for arranging groups of plots
knitr::opts_chunk$set(
  fig.height = 6,
  fig.width = 9
)
```

```{r example data}
# get example phyloseq data from corncob package and tidy up
pseq <- corncob::ibd_phylo %>% 
  tax_filter(min_prevalence = 2) %>% 
  tax_fix() %>% 
  phyloseq_validate()
```

The `comp_barplot` function allows you to visualise the taxonomic
compositions of your microbiome samples in a flexible, scalable,
group-able, and visually appealing way.

## Quick example barplot

Visualise the top Genera across all the female samples from this
inflammatory bowel disease study dataset. The order of the samples is
automatically set by their "bray"-curtis dissimilarity.

By default, the top 8 taxa are shown. These taxa are chosen by their
total count abundance across all plotted samples.

```{r simple}
pseq %>%
  ps_filter(gender == "female") %>%
  comp_barplot(tax_level = "Genus") + 
  coord_flip() # horizontal bars are often more readable
```

## Customising this barplot

The output of comp_barplot can be customised in several ways. See the
comment alongside each argument for an explanation of its effect.

```{r simple customised}
pseq %>%
  ps_filter(gender == "female") %>%
  comp_barplot(
    tax_level = "Genus",
    label = "DiseaseState", # name an alternative variable to label axes
    n_taxa = 15, # give more taxa unique colours
    merge_other = FALSE, # split the "other" category to display alpha diversity
    bar_width = 0.7, # reduce the bar width to 70% of one row
    bar_outline_colour = "grey5" # is the default (use NA to remove outlines)
  ) + 
  coord_flip()
```

**Other notes:**

-   Dissimilarity is calculated using only the visibly distinct taxa, to
    optimise sorting for visual similarity. You can change this by
    setting `order_with_all_taxa = TRUE`, to always use all taxa for
    similarity sorting.
-   The colour palette is important, to allow (adjacent) taxa to be
    distinguished. The palette microViz uses is generated by the
    `distinct_palette` function, which starts with the Paired and Dark2
    palettes from ColorBrewer and continues with further distinct
    colours generated at <http://medialab.github.io/iwanthue/> (all
    colors, soft k-means).

## Averages, faceting or grouping?

### Averaging compositions

Sometimes, to compare microbial compositions across groups, average
compositions are presented. However that "group-averaging" approach
hides a lot of within-group variation, as well as any imbalance in group
sizes.

```{r}
pseq %>%
  ps_select(age, DiseaseState) %>% # avoids lots of phyloseq::merge_samples warnings
  ps_filter(DiseaseState != "IBDundef") %>% 
  phyloseq::merge_samples(group = "DiseaseState") %>%
  comp_barplot(
    tax_level = "Genus", n_taxa = 12,
    bar_width = 0.8
  ) +
  coord_flip() + labs(x = NULL, y = NULL)
```

### Faceting

Faceting is where you show each group on a small subplot.

In the plot below can you see that at minority of UC samples have a high
abundance of Escherichia/Shigella or Streptococcus. The merged bars
above might have misled you into thinking all UC samples had somewhat
increased abundances of these taxa.

```{r}
pseq %>%
  ps_filter(DiseaseState != "IBDundef") %>% # only one sample in this group
  # convert DiseaseState into ordered factor to control order of facets
  ps_mutate(
    DiseaseState = factor(
      DiseaseState, levels = c("UC", "nonIBD", "CD"), ordered = TRUE)
  ) %>% 
  comp_barplot(
    tax_level = "Genus", n_taxa = 15,
    bar_outline_colour = NA, facet_by = "DiseaseState"
  ) +
  coord_flip() 
```

Instead of using the `facet_by` argument in `comp_barplot` you can have
more control over faceting by doing it yourself afterwards. You can use
facet_grid to create row facets.

```{r, fig.height=8, fig.width=6}
pseq %>%
  ps_filter(DiseaseState != "IBDundef") %>% # only one sample in this group
  # convert DiseaseState into ordered factor to control order of facets
  ps_mutate(
    DiseaseState = factor(
      DiseaseState, levels = c("UC", "CD", "nonIBD"), ordered = TRUE)
  ) %>% 
  comp_barplot(
    tax_level = "Genus", n_taxa = 15,
    sample_order = "bray", bar_outline_colour = NA,
  ) +
  facet_grid(
    rows = vars(DiseaseState), 
    scales = "free", space = "free" # these options are critically important!
  ) +
  coord_flip() + 
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
```

### Grouping

For even greater control than faceting, `comp_barplot` allows you to
generate separate ggplot objects for each group, whilst maintaining the
same taxa colour scheme.

You can assemble these plots into one figure with, for example, the
`patchwork` package, or keep them separate.

*Note that the ordering of the samples may differ between facet and
group_by approaches. In the group_by method, the ordering of the samples
by similarity is done separately for each group, whereas in the facet_by
method, similarity-based ordering is done with all samples and then the
samples are separated by facet afterwards.*

```{r}
plot_list <- pseq %>% 
  ps_filter(DiseaseState != "IBDundef") %>% 
  comp_barplot(
  n_taxa = 15, tax_level = "Genus", group_by = "DiseaseState"
)

# Plot them side by side with the patchwork package.
patch <- patchwork::wrap_plots(plot_list, nrow = 1, guides = "collect")
patch & coord_flip() # make all plots horizontal (note: use & instead of +)
```

Notice how you can theme all plots with the `&` operator.

See <https://patchwork.data-imaginist.com/index.html> for more examples
of arranging multiple plots.

```{r}
patch &
  coord_flip() & labs(x = NULL, y = NULL) &
  theme(
    axis.text.y = element_text(size = 5),
    legend.text = element_text(size = 8)
  ) &
  plot_annotation(
    title = "Microbial composition across disease groups",
    caption = "Caption: patchwork is a great package!",
    theme = theme(plot.title = element_text(size = 14, face = "bold"))
  )
```

## Sorting the barplot

### Sorting by similarity

Sorting the samples on compositional barplots by similarity can make
patterns in the data much easier to see. Check out this unsorted version
of the first barplot in this article.

```{r}
pseq %>%
  ps_filter(gender == "female") %>%
  comp_barplot(tax_level = "Genus", sample_order = "default") + 
  coord_flip() +
  ggtitle("Unsorted barcharts are hard to read!")
```

You can play with the dissimilarity measure (set in `sample_order`
argument) and `seriate_method` if you like, but the defaults (Bray
Curtis and OLO Ward) seem to work pretty well most of the time.

When sorting samples by similarity, the default is to treat the "other"
taxa as one group, i.e. when `merge_other = TRUE` and
`order_with_all_taxa = FALSE`.

If you set `order_with_all_taxa = TRUE`, samples are sorted BEFORE
merging taxa. The resulting sample order is then the same as when
`merge_other = FALSE`.

```{r}
pseq %>%
  ps_filter(gender == "female") %>%
  comp_barplot(tax_level = "Genus") + 
  coord_flip() +
  ggtitle("Samples sorted AFTER merging 'other' taxa")

pseq %>%
  ps_filter(gender == "female") %>%
  comp_barplot(tax_level = "Genus", order_with_all_taxa = TRUE) + 
  coord_flip() +
  ggtitle("Samples sorted BEFORE merging 'other' taxa")


pseq %>%
  ps_filter(gender == "female") %>%
  comp_barplot(tax_level = "Genus", merge_other = FALSE) + 
  coord_flip() +
  ggtitle("'other' taxa not merged")

```

### Sort by ordination

Coming soon.

### Sort by 1 taxon

To study the distribution of a single taxonomic group across your
samples, you can use `ps_arrange` (with the `.target` argument set to
"otu_table") and the 'default' sample_order setting in `comp_barplot`.

```{r}
pseq %>% 
   tax_agg("Phylum") %>% 
   tax_transform("compositional") %>% 
   ps_arrange(desc(Firmicutes), .target = "otu_table") %>% 
   comp_barplot(tax_level = "Phylum", sample_order = "default") +
  coord_flip()
```

### Sorting by metadata

Sorting across timepoint groups in another dataset, dietswap.

```{r diet only}
data("dietswap", package = "microbiome")
ps <- dietswap %>% ps_filter(group == "DI")

# subset to participants/"subjects" with samples for both timepoints
timepoint_groups <- sample_data(ps) %>%
  data.frame() %>%
  split.data.frame(f = .$timepoint.within.group)
have_both_timepoints <- intersect(timepoint_groups$`1`$subject, timepoint_groups$`2`$subject)
ps <- ps %>% subset_samples(subject %in% have_both_timepoints)

# define grouping variable for plotting
ps <- ps %>% ps_mutate(
  plot_groups = interaction(nationality, timepoint.within.group)
)
```

Grouped by both timepoint and another grouping factor, nationality in
this example.

```{r, fig.height=7.5, fig.width=10}
times_list <- ps %>%
  ps_arrange(timepoint.within.group, nationality, desc(subject)) %>%
  comp_barplot(
    tax_level = "Genus", n_taxa = 10, sample_order = "default",
    group_by = "plot_groups", bar_width = 0.7, label = "subject"
  )

times <- wrap_plots(
  times_list[c("AAM.1", "AAM.2", "AFR.1", "AFR.2")],
  byrow = TRUE, ncol = 2, guides = "collect", heights = c(5, 4)
) &
  coord_flip() &
  theme(
    text = element_text(size = 10),
    axis.title = element_blank()
  )

times
```

Same grouping, now showing diversity of taxa within other, with
`merge_other = FALSE`

```{r, fig.height=7.5, fig.width=10}
times_list <- ps %>%
  ps_arrange(timepoint.within.group, nationality, desc(subject)) %>%
  comp_barplot(
    tax_level = "Genus", n_taxa = 10, sample_order = "default",
    merge_other = FALSE, bar_outline_colour = "grey10",
    group_by = "plot_groups", bar_width = 0.7, label = "subject"
  )

times <- wrap_plots(
  times_list[c("AAM.1", "AAM.2", "AFR.1", "AFR.2")],
  byrow = TRUE, ncol = 2, guides = "collect", heights = c(5, 4)
) &
  coord_flip() &
  theme(
    text = element_text(size = 10),
    axis.title = element_blank()
  )

times
```

```{r}
devtools::session_info()
```
