---
title: "Visualising-compositions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Visualising-compositions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, message=FALSE}
options(width = 100)
library(microViz)
library(phyloseq)
library(microbiome)
library(patchwork) # for arranging groups of plots
data(dietswap)
knitr::opts_chunk$set(
  fig.height = 6,
  fig.width = 9
)
```

The `plot_comp_bar` function allows you to visualise the taxonomic compositions of your microbiome samples in a flexible, scalable, group-able, and visually appealing way.

## Illustrative simple customised example
```{r}
dietswap %>%
  ps_filter(timepoint == 1) %>%
  plot_comp_bar(
    tax_level = "Family", n_taxa = 8,
    bar_outline_colour = NA,
    sample_order = "bray", bar_width = 0.7
  ) + coord_flip()
```

## Averages or everything?

Often to compare groups, average compositions are presented.
```{r}
p1 <- dietswap %>%
  phyloseq::merge_samples(group = "group") %>%
  plot_comp_bar(
    tax_level = "Genus", n_taxa = 12,
    sample_order = c("ED", "HE", "DI"),
    bar_width = 0.8
  ) +
  coord_flip() + labs(x = NULL, y = NULL)
p1
```

However that "group-averaging" approach hides a lot of within-group variation.
```{r}
p2 <- dietswap %>%
  plot_comp_bar(
    tax_level = "Genus", n_taxa = 12, group_by = "group",
    sample_order = "euclidean", bar_outline_colour = NA, keep_all_vars = TRUE
  ) %>%
  patchwork::wrap_plots(nrow = 3, guides = "collect") &
  coord_flip() &
  labs(x = NULL, y = NULL) &
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
p2 
```


Only from p2 you can see that the apparently higher average relative abundance of Oscillospira in group DI is probably driven largely by a subgroup of DI samples with relatively high Oscillospira.

## Faceting tips: 

```{r}
facets_plot <- plot_comp_bar(
  dietswap,
  n_taxa = 15, tax_level = "Genus",
  bar_outline_colour = "black",
  sample_order = "aitchison", facet_by = "sex"
)
facets_plot + 
  coord_flip() +
  theme(
    axis.text.y = element_text(size = 5),
    legend.text = element_text(size = 8),
    plot.title = element_text(size = 16, face = "bold")
  ) 
```

Faceting grouped plots post-hoc is possible: You can apply faceting to all plots with `&`. Below is an example with plot list object p2 from above.

(remembered that `facet_wrap` with scales = "free" is normally desired).

```{r}
p2 & facet_wrap('sex', scales = 'free')
```

## Customising grouped plots

Remake the 2 harmonised composition plots grouped by sex, but using group_by and patchwork. (Note that the ordering of the samples may differ between facet and group_by approaches. In the group_by method, the ordering of the samples by similarity is done separately for each group, whereas in the facet_by method, similarity-based ordering is done with all samples and then the samples are separated by facet afterwards).

```{r}
plot_list <- plot_comp_bar(
  dietswap,
  n_taxa = 15, tax_level = "Genus",
  bar_outline_colour = "black",
  sample_order = "aitchison", group_by = "sex"
)
```

Plot them side by side with the patchwork package.
```{r}
patch <- patchwork::wrap_plots(plot_list, ncol = 2, guides = "collect")
patch & coord_flip() # make bars in all plots horizontal (note: use & instead of +)
```

Modify one plot in place (flip the order of the samples in the 2nd plot).
*Notice that the scaling is for the x-axis. That's because* `coord_flip` *is used afterwards when displaying the plots*

```{r}
patch[[2]] <- patch[[2]] + scale_x_discrete(limits = rev)
# Explainer: rev() function takes current axis limits and reverses them.
# You could also pass a completely arbitrary order to limits, naming all samples.
```

Notice how you can theme all plots with the `&` operator. 

See https://patchwork.data-imaginist.com/index.html for more examples of arranging multiple plots.

```{r}
patch &
  coord_flip() & labs(x = NULL, y = NULL) &
  theme(
    axis.text.y = element_text(size = 5),
    legend.text = element_text(size = 8)
  ) &
  plot_annotation(
    title = "Comparing microbial composition across sexes",
    caption = "Caption: patchwork is a great package!",
    theme = theme(plot.title = element_text(size = 16, face = "bold"))
  )
```

## Sorting samples manually

Sorting across timepoint groups, example.

```{r diet only}
ps <- dietswap %>% ps_filter(group == "DI")

# subset to participants/"subjects" with samples for both timepoints
timepoint_groups <- sample_data(ps) %>%
  data.frame() %>%
  split.data.frame(f = .$timepoint.within.group)
have_both_timepoints <- intersect(timepoint_groups$`1`$subject, timepoint_groups$`2`$subject)
ps <- ps %>% subset_samples(subject %in% have_both_timepoints)

# define grouping variable for plotting
ps <- ps %>% ps_mutate(
  plot_groups = interaction(nationality, timepoint.within.group)
)
```

Grouped by both timepoint and another grouping factor, nationality in this example.

```{r, fig.height=7.5, fig.width=10}
times_list <- ps %>%
  ps_arrange(timepoint.within.group, nationality, desc(subject)) %>%
  plot_comp_bar(
    tax_level = "Genus", n_taxa = 10, sample_order = "default",
    group_by = "plot_groups", bar_width = 0.7, label = "subject"
  )

times <- wrap_plots(
  times_list[c("AAM.1", "AAM.2", "AFR.1", "AFR.2")],
  byrow = TRUE, ncol = 2, guides = "collect", heights = c(5, 4)
) &
  coord_flip() &
  theme(
    text = element_text(size = 10),
    axis.title = element_blank()
  )

times
```

```{r}
devtools::session_info()
```
 
 
