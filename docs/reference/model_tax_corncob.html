<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Beta binomial taxon models with corncob — model_tax_corncob • microViz</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Beta binomial taxon models with corncob — model_tax_corncob" />
<meta property="og:description" content="Takes a phyloseq and returns a list of models, one for each taxon.
Same independent variables for all models. Same variables for modelling both the abundance and dispersion parameters.
P-values are from wald tests for simplicity and speed... maybe I will change this in the future.
Use this function with the output of model_tax_corncob. models2stats_corncob splits the statistical results extracted from corncob models and groups them by the independent variable name that they refer to. One dataframe of this list can then be joined to the output of taxatree_nodes to prepare for taxonomic heat tree graph visualisation of taxon-variable associations." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">microViz</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/PCA-sorted-polar-composition-plots.html">PCA-sorted polar composition plots</a>
    </li>
    <li>
      <a href="../articles/tree-development.html">tree-development</a>
    </li>
    <li>
      <a href="../articles/Visualising-compositions.html">Visualising-compositions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/david-barnett/microViz/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Beta binomial taxon models with corncob</h1>
    <small class="dont-index">Source: <a href='https://github.com/david-barnett/microViz/blob/master/R/model_tax_corncob.R'><code>R/model_tax_corncob.R</code></a></small>
    <div class="hidden name"><code>model_tax_corncob.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Takes a phyloseq and returns a list of models, one for each taxon.
Same independent variables for all models. Same variables for modelling both the abundance and dispersion parameters.
P-values are from wald tests for simplicity and speed... maybe I will change this in the future.</p>
<p>Use this function with the output of <code>model_tax_corncob</code>. <code>models2stats_corncob</code> splits the statistical results extracted from corncob models and groups them by the independent variable name that they refer to. One dataframe of this list can then be joined to the output of taxatree_nodes to prepare for taxonomic heat tree graph visualisation of taxon-variable associations.</p>
    </div>

    <pre class="usage"><span class='fu'>model_tax_corncob</span><span class='op'>(</span><span class='va'>ps</span>, <span class='va'>tax_level</span>, <span class='va'>variables</span>, taxa <span class='op'>=</span> <span class='st'>"all"</span><span class='op'>)</span>

<span class='fu'>models2stats_corncob</span><span class='op'>(</span><span class='va'>taxon_models</span><span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>ps</th>
      <td><p>phyloseq object</p></td>
    </tr>
    <tr>
      <th>tax_level</th>
      <td><p>name of taxonomic rank to aggregate to and model taxa at</p></td>
    </tr>
    <tr>
      <th>variables</th>
      <td><p>vector of variable names to use in corncob beta binomial model</p></td>
    </tr>
    <tr>
      <th>taxa</th>
      <td><p>taxa to model (named, numbered, or defaulting to 'all')</p></td>
    </tr>
    <tr>
      <th>taxon_models</th>
      <td><p>named list output of <code>model_tax_corncob</code></p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>list of dataframes, one df per independent variable</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p><code>model_tax_corncob</code> can use parallel processing with the <code>future</code> package.
This speeds up analysis if you have many taxa to model.
Run a line like this beforehand: <code><a href='https://rdrr.io/pkg/future/man/plan.html'>future::plan(future::multisession, workers = 3)</a></code></p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># corncob stats testing</span>

<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://dplyr.tidyverse.org'>dplyr</a></span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'></span>
#&gt; <span class='message'>Attaching package: 'dplyr'</span></div><div class='output co'>#&gt; <span class='message'>The following objects are masked from 'package:stats':</span>
#&gt; <span class='message'></span>
#&gt; <span class='message'>    filter, lag</span></div><div class='output co'>#&gt; <span class='message'>The following objects are masked from 'package:base':</span>
#&gt; <span class='message'></span>
#&gt; <span class='message'>    intersect, setdiff, setequal, union</span></div><div class='input'><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tibble.tidyverse.org/'>tibble</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://dx.plos.org/10.1371/journal.pone.0061217'>phyloseq</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://microbiome.github.io/microbiome'>microbiome</a></span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'>Loading required package: ggplot2</span></div><div class='output co'>#&gt; <span class='message'></span>
#&gt; <span class='message'>microbiome R package (microbiome.github.com)</span>
#&gt; <span class='message'>    </span>
#&gt; <span class='message'></span>
#&gt; <span class='message'></span>
#&gt; <span class='message'> Copyright (C) 2011-2020 Leo Lahti, </span>
#&gt; <span class='message'>    Sudarshan Shetty et al. &lt;microbiome.github.io&gt;</span></div><div class='output co'>#&gt; <span class='message'></span>
#&gt; <span class='message'>Attaching package: 'microbiome'</span></div><div class='output co'>#&gt; <span class='message'>The following object is masked from 'package:ggplot2':</span>
#&gt; <span class='message'></span>
#&gt; <span class='message'>    alpha</span></div><div class='output co'>#&gt; <span class='message'>The following object is masked from 'package:vegan':</span>
#&gt; <span class='message'></span>
#&gt; <span class='message'>    diversity</span></div><div class='output co'>#&gt; <span class='message'>The following object is masked from 'package:base':</span>
#&gt; <span class='message'></span>
#&gt; <span class='message'>    transform</span></div><div class='input'><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>corncob</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/HenrikBengtsson/future'>future</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/HenrikBengtsson/future.apply'>future.apply</a></span><span class='op'>)</span>

<span class='fu'><a href='https://rdrr.io/r/utils/data.html'>data</a></span><span class='op'>(</span><span class='va'>dietswap</span><span class='op'>)</span>
<span class='va'>ps</span> <span class='op'>&lt;-</span> <span class='va'>dietswap</span>

<span class='co'># create some binary variables for easy visualisation</span>
<span class='fu'><a href='https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html'>sample_data</a></span><span class='op'>(</span><span class='va'>ps</span><span class='op'>)</span><span class='op'>$</span><span class='va'>female</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/if_else.html'>if_else</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html'>sample_data</a></span><span class='op'>(</span><span class='va'>ps</span><span class='op'>)</span><span class='op'>$</span><span class='va'>sex</span> <span class='op'>==</span> <span class='st'>"female"</span>, <span class='fl'>1</span>, <span class='fl'>0</span>, <span class='cn'>NaN</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html'>sample_data</a></span><span class='op'>(</span><span class='va'>ps</span><span class='op'>)</span><span class='op'>$</span><span class='va'>overweight</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/if_else.html'>if_else</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html'>sample_data</a></span><span class='op'>(</span><span class='va'>ps</span><span class='op'>)</span><span class='op'>$</span><span class='va'>bmi_group</span> <span class='op'>==</span> <span class='st'>"overweight"</span>, <span class='fl'>1</span>, <span class='fl'>0</span>, <span class='cn'>NaN</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html'>sample_data</a></span><span class='op'>(</span><span class='va'>ps</span><span class='op'>)</span><span class='op'>$</span><span class='va'>obese</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/if_else.html'>if_else</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html'>sample_data</a></span><span class='op'>(</span><span class='va'>ps</span><span class='op'>)</span><span class='op'>$</span><span class='va'>bmi_group</span> <span class='op'>==</span> <span class='st'>"obese"</span>, <span class='fl'>1</span>, <span class='fl'>0</span>, <span class='cn'>NaN</span><span class='op'>)</span>

<span class='co'># This example dataset has some taxa with the same name for phylum and family...</span>
<span class='co'># We can fix problems like this with the tax_prepend_ranks function</span>
<span class='va'>ps</span> <span class='op'>&lt;-</span> <span class='fu'><a href='tax_table_helpers.html'>tax_prepend_ranks</a></span><span class='op'>(</span><span class='va'>ps</span><span class='op'>)</span>
<span class='co'># this example dataset also has no root, this is unusual and needs to be fixed</span>
<span class='fu'><a href='https://rdrr.io/pkg/phyloseq/man/tax_table-methods.html'>tax_table</a></span><span class='op'>(</span><span class='va'>ps</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span>root <span class='op'>=</span> <span class='st'>"root"</span>, <span class='fu'><a href='https://rdrr.io/pkg/phyloseq/man/tax_table-methods.html'>tax_table</a></span><span class='op'>(</span><span class='va'>ps</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># filter out rare taxa</span>
<span class='va'>ps</span> <span class='op'>&lt;-</span> <span class='va'>ps</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='tax_filter.html'>tax_filter</a></span><span class='op'>(</span>min_prevalence <span class='op'>=</span> <span class='fl'>0.2</span>, min_total_abundance <span class='op'>=</span> <span class='fl'>10000</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'>Proportional min_prevalence given: 0.2 --&gt; min 45/222 samples.</span></div><div class='input'>
<span class='co'># specify variables used for modelling</span>
<span class='va'>variables</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"female"</span>, <span class='st'>"overweight"</span>, <span class='st'>"obese"</span><span class='op'>)</span>

<span class='co'># model_tax_corncob can use parallel processing with the futures package</span>
<span class='co'># this speeds up analysis if you have many taxa to model</span>
<span class='co'># e.g. # future::plan(future::multisession, workers = 3)</span>

<span class='co'># prep for tree viz #</span>
<span class='co'># model taxa at all taxonomic levels (except root)</span>
<span class='va'>tax_models_list</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>lapply</a></span><span class='op'>(</span>
  X <span class='op'>=</span> <span class='fu'>phyloseq</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/phyloseq/man/rank_names.html'>rank_names</a></span><span class='op'>(</span><span class='va'>ps</span><span class='op'>)</span><span class='op'>[</span><span class='op'>-</span><span class='fl'>1</span><span class='op'>]</span>,
  <span class='kw'>function</span><span class='op'>(</span><span class='va'>r</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='fu'><a href='https://rdrr.io/r/base/message.html'>message</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Sys.time.html'>Sys.time</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='st'>" - modelling at level: "</span>, <span class='va'>r</span><span class='op'>)</span>
    <span class='va'>models</span> <span class='op'>&lt;-</span> <span class='fu'>model_tax_corncob</span><span class='op'>(</span><span class='va'>ps</span>, tax_level <span class='op'>=</span> <span class='va'>r</span>, variables <span class='op'>=</span> <span class='va'>variables</span>, taxa <span class='op'>=</span> <span class='st'>"all"</span><span class='op'>)</span>
    <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>models</span><span class='op'>)</span>
  <span class='op'>}</span>
<span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'>2021-01-19 11:37:37 - modelling at level: Phylum</span></div><div class='output co'>#&gt; <span class='message'>2021-01-19 11:37:39 - modelling at level: Family</span></div><div class='output co'>#&gt; <span class='message'>2021-01-19 11:37:41 - modelling at level: Genus</span></div><div class='input'><span class='co'># Flatten all taxonomic level lists into one list of models</span>
<span class='co'># (this is why taxon names must be completely identifiable across ranks)</span>
<span class='va'>flat_models_list</span> <span class='op'>&lt;-</span> <span class='fu'>purrr</span><span class='fu'>::</span><span class='fu'><a href='https://purrr.tidyverse.org/reference/flatten.html'>flatten</a></span><span class='op'>(</span><span class='va'>tax_models_list</span><span class='op'>)</span>
<span class='va'>var_stats</span> <span class='op'>&lt;-</span> <span class='fu'>models2stats_corncob</span><span class='op'>(</span><span class='va'>flat_models_list</span><span class='op'>)</span>

<span class='co'># future::plan(future::sequential) # to turn parallel processing back off</span>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by David Barnett.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


