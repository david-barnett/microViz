<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Plot (grouped and ordered) compositional barplots — comp_barplot • microViz</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous"><link href="../docsearch.css" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Plot (grouped and ordered) compositional barplots — comp_barplot"><meta property="og:description" content='Stacked barplots showing composition of phyloseq samples for a specified number of coloured taxa.
Normally your phyloseq object should contain counts data,
as by default comp_barplot() performs the "compositional" taxa transformation for you,
and requires count input for some sample_order methods!'><meta property="og:image" content="https://david-barnett.github.io/microViz/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-2YQ669S4V5"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-2YQ669S4V5');
</script></head><body data-spy="scroll" data-target="#toc">


    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">microViz</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.12.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/shao19-analyses.html">Getting Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/web-only/phyloseq.html">Working with phyloseq objects</a>
    </li>
    <li>
      <a href="../articles/web-only/tax-fixing.html">Fixing your tax_table</a>
    </li>
    <li>
      <a href="../articles/web-only/ordination.html">Ordination plots</a>
    </li>
    <li>
      <a href="../articles/web-only/ordination-interactive.html">Interactive ordination plots</a>
    </li>
    <li>
      <a href="../articles/web-only/compositions.html">Visualising compositions with barplots</a>
    </li>
    <li>
      <a href="../articles/web-only/heatmaps.html">Heatmaps of microbiome composition or correlation</a>
    </li>
    <li>
      <a href="../articles/web-only/modelling-taxa.html">Statistical modelling of individual taxa</a>
    </li>
    <li>
      <a href="../articles/web-only/videos.html">Tutorial video</a>
    </li>
    <li>
      <a href="../articles/ps_extra-replaced.html">Upgrading to microViz version 0.10.0</a>
    </li>
    <li>
      <a href="../articles/web-only/atlas1006.html">Example analyses with atlas1006 data</a>
    </li>
  </ul></li>
<li>
  <a href="../articles/learn/exercises.html">Learn</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li class="dropdown-header">
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/david-barnett/microViz/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul><form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off"></div>
      </form>

    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Plot (grouped and ordered) compositional barplots</h1>
    <small class="dont-index">Source: <a href="https://github.com/david-barnett/microViz/blob/main/R/comp_barplot.R" class="external-link"><code>R/comp_barplot.R</code></a></small>
    <div class="hidden name"><code>comp_barplot.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Stacked barplots showing composition of phyloseq samples for a specified number of coloured taxa.
Normally your phyloseq object should contain counts data,
as by default <code>comp_barplot()</code> performs the "compositional" taxa transformation for you,
and requires count input for some sample_order methods!</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">comp_barplot</span><span class="op">(</span></span>
<span>  <span class="va">ps</span>,</span>
<span>  <span class="va">tax_level</span>,</span>
<span>  n_taxa <span class="op">=</span> <span class="fl">8</span>,</span>
<span>  tax_order <span class="op">=</span> <span class="va">sum</span>,</span>
<span>  merge_other <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  taxon_renamer <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/identity.html" class="external-link">identity</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>  sample_order <span class="op">=</span> <span class="st">"bray"</span>,</span>
<span>  order_with_all_taxa <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  label <span class="op">=</span> <span class="st">"SAMPLE"</span>,</span>
<span>  group_by <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  facet_by <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  bar_width <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  bar_outline_colour <span class="op">=</span> <span class="st">"grey5"</span>,</span>
<span>  bar_outline_width <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  palette <span class="op">=</span> <span class="fu"><a href="distinct_palette.html">distinct_palette</a></span><span class="op">(</span><span class="va">n_taxa</span><span class="op">)</span>,</span>
<span>  tax_transform_for_ordering <span class="op">=</span> <span class="st">"identity"</span>,</span>
<span>  tax_transform_for_plot <span class="op">=</span> <span class="st">"compositional"</span>,</span>
<span>  seriate_method <span class="op">=</span> <span class="st">"OLO_ward"</span>,</span>
<span>  keep_all_vars <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  interactive <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  max_taxa <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>  other_name <span class="op">=</span> <span class="st">"Other"</span>,</span>
<span>  x <span class="op">=</span> <span class="st">"SAMPLE"</span>,</span>
<span>  counts_warn <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>


<dl><dt id="arg-ps">ps<a class="anchor" aria-label="anchor" href="#arg-ps"></a></dt>
<dd><p>phyloseq object</p></dd>


<dt id="arg-tax-level">tax_level<a class="anchor" aria-label="anchor" href="#arg-tax-level"></a></dt>
<dd><p>taxonomic aggregation level (from rank_names(ps))</p></dd>


<dt id="arg-n-taxa">n_taxa<a class="anchor" aria-label="anchor" href="#arg-n-taxa"></a></dt>
<dd><p>how many taxa to show distinct colours for (all others grouped into "Other")</p></dd>


<dt id="arg-tax-order">tax_order<a class="anchor" aria-label="anchor" href="#arg-tax-order"></a></dt>
<dd><p>order of taxa within the bars, either a function for tax_sort (e.g. sum),
or a vector of (all) taxa names at tax_level to set order manually</p></dd>


<dt id="arg-merge-other">merge_other<a class="anchor" aria-label="anchor" href="#arg-merge-other"></a></dt>
<dd><p>if FALSE, taxa coloured/filled as "other" remain distinct,
and so can have bar outlines drawn around them</p></dd>


<dt id="arg-taxon-renamer">taxon_renamer<a class="anchor" aria-label="anchor" href="#arg-taxon-renamer"></a></dt>
<dd><p>function that takes taxon names and returns modified names for legend</p></dd>


<dt id="arg-sample-order">sample_order<a class="anchor" aria-label="anchor" href="#arg-sample-order"></a></dt>
<dd><p>vector of sample names;
or any distance measure in dist_calc that doesn't require phylogenetic tree;
or "asis" for the current order as is returned by phyloseq::sample_names(ps)</p></dd>


<dt id="arg-order-with-all-taxa">order_with_all_taxa<a class="anchor" aria-label="anchor" href="#arg-order-with-all-taxa"></a></dt>
<dd><p>if TRUE, this will always use all taxa (not just the top n_taxa)
to calculate any distances needed for sample ordering</p></dd>


<dt id="arg-label">label<a class="anchor" aria-label="anchor" href="#arg-label"></a></dt>
<dd><p>name of variable to use for labelling samples, or "SAMPLE" for sample names</p></dd>


<dt id="arg-group-by">group_by<a class="anchor" aria-label="anchor" href="#arg-group-by"></a></dt>
<dd><p>splits dataset by this variable (must be categorical)</p><ul><li><p>resulting in a list of plots, one for each level of the group_by variable.</p></li>
</ul></dd>


<dt id="arg-facet-by">facet_by<a class="anchor" aria-label="anchor" href="#arg-facet-by"></a></dt>
<dd><p>facets plots by this variable (must be categorical). If group_by is also set
the faceting will occur separately in the plot for each group.</p></dd>


<dt id="arg-bar-width">bar_width<a class="anchor" aria-label="anchor" href="#arg-bar-width"></a></dt>
<dd><p>default 1 avoids random gapping otherwise seen with many samples
(set to less than 1 to introduce gaps between samples)</p></dd>


<dt id="arg-bar-outline-colour">bar_outline_colour<a class="anchor" aria-label="anchor" href="#arg-bar-outline-colour"></a></dt>
<dd><p>line colour separating taxa and samples (use NA for no outlines)</p></dd>


<dt id="arg-bar-outline-width">bar_outline_width<a class="anchor" aria-label="anchor" href="#arg-bar-outline-width"></a></dt>
<dd><p>width of line separating taxa and samples
(for no outlines set bar_outline_colour = NA)</p></dd>


<dt id="arg-palette">palette<a class="anchor" aria-label="anchor" href="#arg-palette"></a></dt>
<dd><p>palette for taxa fill colours</p></dd>


<dt id="arg-tax-transform-for-ordering">tax_transform_for_ordering<a class="anchor" aria-label="anchor" href="#arg-tax-transform-for-ordering"></a></dt>
<dd><p>transformation of taxa values used before ordering samples by similarity</p></dd>


<dt id="arg-tax-transform-for-plot">tax_transform_for_plot<a class="anchor" aria-label="anchor" href="#arg-tax-transform-for-plot"></a></dt>
<dd><p>default "compositional" draws proportions of total counts per sample,
but you could reasonably use another transformation,
e.g. "identity", if you have truly quantitative microbiome profiling data</p></dd>


<dt id="arg-seriate-method">seriate_method<a class="anchor" aria-label="anchor" href="#arg-seriate-method"></a></dt>
<dd><p>name of any ordering method suitable for distance matrices
(see ?seriation::seriate)</p></dd>


<dt id="arg-keep-all-vars">keep_all_vars<a class="anchor" aria-label="anchor" href="#arg-keep-all-vars"></a></dt>
<dd><p>FALSE may speed up internal melting with ps_melt for large phyloseq objects
but TRUE is required for some post-hoc plot customisation</p></dd>


<dt id="arg-interactive">interactive<a class="anchor" aria-label="anchor" href="#arg-interactive"></a></dt>
<dd><p>creates plot suitable for use with ggiraph</p></dd>


<dt id="arg-max-taxa">max_taxa<a class="anchor" aria-label="anchor" href="#arg-max-taxa"></a></dt>
<dd><p>maximum distinct taxa groups to show
(only really useful for limiting complexity of interactive plots
e.g. within ord_explore)</p></dd>


<dt id="arg-other-name">other_name<a class="anchor" aria-label="anchor" href="#arg-other-name"></a></dt>
<dd><p>name for other taxa after N</p></dd>


<dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>name of variable to use as x aesthetic:
it probably only makes sense to change this when also using facets
(check only one sample is represented per bar!)</p></dd>


<dt id="arg-counts-warn">counts_warn<a class="anchor" aria-label="anchor" href="#arg-counts-warn"></a></dt>
<dd><p>should a warning be issued if counts are unavailable?
TRUE, FALSE, or "error" (passed to ps_get)</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>extra arguments passed to facet_wrap() (if facet_by is not NA)</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p>ggplot or list of harmonised ggplots</p>
    </div>
    <div id="details">
    <h2>Details</h2>

<ul><li><p>sample_order: Either specify a list of sample names to order manually, or the bars/samples can/will be sorted by similarity, according to a specified distance measure (default 'bray'-curtis),</p></li>
<li><p>seriate_method specifies a seriation/ordering algorithm (default Ward hierarchical clustering with optimal leaf ordering, see seriation::list_seriation_methods())</p></li>
<li><p>group_by: You can group the samples on distinct plots by levels of a variable in the phyloseq object. The list of ggplots produced can be arranged flexibly with the patchwork package functions. If you want to group by several variables you can create an interaction variable with interaction(var1, var2) in the phyloseq sample_data BEFORE using comp_barplot.</p></li>
<li><p>facet_by can allow faceting of your plot(s) by a grouping variable. Using this approach is less flexible than using group_by but means you don't have to arrange a list of plots yourself like with the group_by argument. Using facet_by is equivalent to adding a call to facet_wrap(facets = facet_by, scales = "free") to your plot(s). Calling facet_wrap() yourself is itself a more flexible option as you can add other arguments like the number of rows etc. However you must use keep_all_vars = TRUE if you will add faceting manually.</p></li>
<li><p>bar_width: No gaps between bars, unless you want them (decrease width argument to add gaps between bars).</p></li>
<li><p>bar_outline_colour: Bar outlines default to "grey5" for almost black outlines. Use NA if you don't want outlines.</p></li>
<li><p>merge_other: controls whether bar outlines can be drawn around individual (lower abundance) taxa that are grouped in "other" category. If you want to see the diversity of taxa in "other" use merge_taxa = FALSE, or use TRUE if you prefer the cleaner merged look</p></li>
<li><p>palette: Default colouring is consistent across multiple plots if created with the group_by argument, and the defaults scheme retains the colouring of the most abundant taxa irrespective of n_taxa</p></li>
</ul></div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">dietswap</span>, package <span class="op">=</span> <span class="st">"microbiome"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># illustrative simple customised example</span></span></span>
<span class="r-in"><span><span class="va">dietswap</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="ps_filter.html">ps_filter</a></span><span class="op">(</span><span class="va">timepoint</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">comp_barplot</span><span class="op">(</span></span></span>
<span class="r-in"><span>    tax_level <span class="op">=</span> <span class="st">"Family"</span>, n_taxa <span class="op">=</span> <span class="fl">8</span>,</span></span>
<span class="r-in"><span>    bar_outline_colour <span class="op">=</span> <span class="cn">NA</span>,</span></span>
<span class="r-in"><span>    sample_order <span class="op">=</span> <span class="st">"bray"</span>,</span></span>
<span class="r-in"><span>    bar_width <span class="op">=</span> <span class="fl">0.7</span>,</span></span>
<span class="r-in"><span>    taxon_renamer <span class="op">=</span> <span class="va">toupper</span></span></span>
<span class="r-in"><span>  <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Registered S3 method overwritten by 'seriation':</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>   method         from </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>   reorder.hclust vegan</span>
<span class="r-plt img"><img src="comp_barplot-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># change colour palette with the distinct_palette() function</span></span></span>
<span class="r-in"><span><span class="co"># remember to set the number of colours to the same as n_taxa argument!</span></span></span>
<span class="r-in"><span><span class="va">dietswap</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="ps_filter.html">ps_filter</a></span><span class="op">(</span><span class="va">timepoint</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">comp_barplot</span><span class="op">(</span></span></span>
<span class="r-in"><span>    tax_level <span class="op">=</span> <span class="st">"Family"</span>, n_taxa <span class="op">=</span> <span class="fl">8</span>,</span></span>
<span class="r-in"><span>    bar_outline_colour <span class="op">=</span> <span class="cn">NA</span>,</span></span>
<span class="r-in"><span>    sample_order <span class="op">=</span> <span class="st">"bray"</span>,</span></span>
<span class="r-in"><span>    bar_width <span class="op">=</span> <span class="fl">0.7</span>,</span></span>
<span class="r-in"><span>    palette <span class="op">=</span> <span class="fu"><a href="distinct_palette.html">distinct_palette</a></span><span class="op">(</span><span class="fl">8</span>, pal <span class="op">=</span> <span class="st">"kelly"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    taxon_renamer <span class="op">=</span> <span class="va">toupper</span></span></span>
<span class="r-in"><span>  <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="comp_barplot-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Order samples by the value of one of more sample_data variables.</span></span></span>
<span class="r-in"><span><span class="co"># Use ps_arrange and set sample_order = "default" in comp_barplot.</span></span></span>
<span class="r-in"><span><span class="co"># ps_mutate is also used here to create an informative variable for axis labelling</span></span></span>
<span class="r-in"><span><span class="va">dietswap</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="ps_mutate.html">ps_mutate</a></span><span class="op">(</span>subject_timepoint <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html" class="external-link">interaction</a></span><span class="op">(</span><span class="va">subject</span>, <span class="va">timepoint</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="ps_filter.html">ps_filter</a></span><span class="op">(</span><span class="va">nationality</span> <span class="op">==</span> <span class="st">"AAM"</span>, <span class="va">group</span> <span class="op">==</span> <span class="st">"DI"</span>, <span class="va">sex</span> <span class="op">==</span> <span class="st">"female"</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="ps_arrange.html">ps_arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">subject</span><span class="op">)</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">timepoint</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">comp_barplot</span><span class="op">(</span></span></span>
<span class="r-in"><span>    tax_level <span class="op">=</span> <span class="st">"Genus"</span>, n_taxa <span class="op">=</span> <span class="fl">12</span>,</span></span>
<span class="r-in"><span>    sample_order <span class="op">=</span> <span class="st">"default"</span>,</span></span>
<span class="r-in"><span>    bar_width <span class="op">=</span> <span class="fl">0.7</span>,</span></span>
<span class="r-in"><span>    bar_outline_colour <span class="op">=</span> <span class="st">"black"</span>,</span></span>
<span class="r-in"><span>    order_with_all_taxa <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>    label <span class="op">=</span> <span class="st">"subject_timepoint"</span></span></span>
<span class="r-in"><span>  <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="comp_barplot-3.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Order taxa differently:</span></span></span>
<span class="r-in"><span><span class="co"># By default, taxa are ordered by total sum across all samples</span></span></span>
<span class="r-in"><span><span class="co"># You can set a different function for calculating the order, e.g. median</span></span></span>
<span class="r-in"><span><span class="va">dietswap</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="ps_filter.html">ps_filter</a></span><span class="op">(</span><span class="va">timepoint</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">comp_barplot</span><span class="op">(</span>tax_level <span class="op">=</span> <span class="st">"Genus"</span>, tax_order <span class="op">=</span> <span class="va">median</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="comp_barplot-4.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Or you can set the taxa order up front, with tax_sort() and use it as is</span></span></span>
<span class="r-in"><span><span class="va">dietswap</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="ps_filter.html">ps_filter</a></span><span class="op">(</span><span class="va">timepoint</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="tax_sort.html">tax_sort</a></span><span class="op">(</span>at <span class="op">=</span> <span class="st">"Genus"</span>, by <span class="op">=</span> <span class="va">sum</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">comp_barplot</span><span class="op">(</span>tax_level <span class="op">=</span> <span class="st">"Genus"</span>, tax_order <span class="op">=</span> <span class="st">"asis"</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="comp_barplot-5.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># how many taxa are in those light grey "other" bars?</span></span></span>
<span class="r-in"><span><span class="co"># set merge_other to find out (&amp; remember to set a bar_outline_colour)</span></span></span>
<span class="r-in"><span><span class="va">dietswap</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="ps_filter.html">ps_filter</a></span><span class="op">(</span><span class="va">timepoint</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">comp_barplot</span><span class="op">(</span></span></span>
<span class="r-in"><span>    tax_level <span class="op">=</span> <span class="st">"Genus"</span>, n_taxa <span class="op">=</span> <span class="fl">12</span>, merge_other <span class="op">=</span> <span class="cn">FALSE</span>, bar_outline_colour <span class="op">=</span> <span class="st">"grey50"</span>,</span></span>
<span class="r-in"><span>  <span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="comp_barplot-6.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Often to compare groups, average compositions are presented</span></span></span>
<span class="r-in"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">phyloseq</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/merge_samples-methods.html" class="external-link">merge_samples</a></span><span class="op">(</span><span class="va">dietswap</span>, group <span class="op">=</span> <span class="st">"group"</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">comp_barplot</span><span class="op">(</span></span></span>
<span class="r-in"><span>    tax_level <span class="op">=</span> <span class="st">"Genus"</span>, n_taxa <span class="op">=</span> <span class="fl">12</span>,</span></span>
<span class="r-in"><span>    sample_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ED"</span>, <span class="st">"HE"</span>, <span class="st">"DI"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    bar_width <span class="op">=</span> <span class="fl">0.8</span></span></span>
<span class="r-in"><span>  <span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>NAs introduced by coercion</span>
<span class="r-in"><span><span class="va">p1</span></span></span>
<span class="r-plt img"><img src="comp_barplot-7.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># However that "group-averaging" approach hides a lot of within-group variation</span></span></span>
<span class="r-in"><span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">comp_barplot</span><span class="op">(</span><span class="va">dietswap</span>,</span></span>
<span class="r-in"><span>  tax_level <span class="op">=</span> <span class="st">"Genus"</span>, n_taxa <span class="op">=</span> <span class="fl">12</span>, group_by <span class="op">=</span> <span class="st">"group"</span>,</span></span>
<span class="r-in"><span>  sample_order <span class="op">=</span> <span class="st">"euclidean"</span>, bar_outline_colour <span class="op">=</span> <span class="cn">NA</span></span></span>
<span class="r-in"><span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link">wrap_plots</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">3</span>, guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span> <span class="op">&amp;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">&amp;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">p2</span></span></span>
<span class="r-plt img"><img src="comp_barplot-8.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Only from p2 you can see that the apparently higher average relative abundance</span></span></span>
<span class="r-in"><span><span class="co"># of Oscillospira in group DI is probably driven largely by a subgroup</span></span></span>
<span class="r-in"><span><span class="co"># of DI samples with relatively high Oscillospira.</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># make a list of 2 harmonised composition plots (grouped by sex)</span></span></span>
<span class="r-in"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">comp_barplot</span><span class="op">(</span><span class="va">dietswap</span>,</span></span>
<span class="r-in"><span>  n_taxa <span class="op">=</span> <span class="fl">15</span>, tax_level <span class="op">=</span> <span class="st">"Genus"</span>,</span></span>
<span class="r-in"><span>  bar_outline_colour <span class="op">=</span> <span class="st">"black"</span>, merge_other <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>  sample_order <span class="op">=</span> <span class="st">"aitchison"</span>, group_by <span class="op">=</span> <span class="st">"sex"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># plot them side by side with patchwork package</span></span></span>
<span class="r-in"><span><span class="va">patch</span> <span class="op">&lt;-</span> <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link">wrap_plots</a></span><span class="op">(</span><span class="va">p</span>, ncol <span class="op">=</span> <span class="fl">2</span>, guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">patch</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># make bars in all plots horizontal (note: use &amp; instead of +)</span></span></span>
<span class="r-plt img"><img src="comp_barplot-9.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># beautifying tweak #</span></span></span>
<span class="r-in"><span><span class="co"># modify one plot in place (flip the order of the samples in the 2nd plot)</span></span></span>
<span class="r-in"><span><span class="co"># notice that the scaling is for the x-axis</span></span></span>
<span class="r-in"><span><span class="co"># (that's because coord_flip is used afterwards when displaying the plots</span></span></span>
<span class="r-in"><span><span class="va">patch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">patch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_x_discrete</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="va">rev</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Scale for <span style="color: #00BB00;">x</span> is already present.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Adding another scale for <span style="color: #00BB00;">x</span>, which will replace the existing scale.</span>
<span class="r-in"><span><span class="co"># Explainer: rev() function takes current limits and reverses them.</span></span></span>
<span class="r-in"><span><span class="co"># You could also pass a completely arbitrary order, naming all samples</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># you can theme all plots with the &amp; operator</span></span></span>
<span class="r-in"><span><span class="va">patch</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&amp;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>, legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="comp_barplot-10.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co"># See https://patchwork.data-imaginist.com/index.html</span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by David Barnett.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer></div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({


    apiKey: '22e6f0a75b7b1ffae9bf5bc5b58864d7',
    indexName: 'microViz',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script><script data-goatcounter="https://microviz.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></body></html>

